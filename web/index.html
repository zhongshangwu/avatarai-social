<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="origin-when-cross-origin">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.purple.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>AvatarAI Social - 智能社交平台</title>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #5855eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            margin: 0;
            background: linear-gradient(135deg, var(--primary-color), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .user-greeting {
            color: var(--text-light);
            margin: 10px 0 0 0;
            font-size: 1.1rem;
        }

        .nav-menu {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-menu button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-menu button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            margin: 0 0 20px 0;
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: var(--text-light);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            animation: slideIn 0.3s ease-out;
        }

        .message.error {
            background: #fef2f2;
            color: var(--error-color);
            border: 1px solid #fecaca;
        }

        .message.success {
            background: #f0fdf4;
            color: var(--success-color);
            border: 1px solid #bbf7d0;
        }

        .message.warning {
            background: #fffbeb;
            color: var(--warning-color);
            border: 1px solid #fed7aa;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.btn-success {
            background: var(--success-color);
        }

        .btn.btn-success:hover {
            background: #059669;
        }

        .btn.btn-danger {
            background: var(--error-color);
        }

        .btn.btn-danger:hover {
            background: #dc2626;
        }

        .user-info {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .user-info p {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info strong {
            color: #374151;
            min-width: 60px;
        }

        .user-info span {
            color: var(--text-light);
            font-family: 'Monaco', 'Menlo', monospace;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* 用户资料显示样式 */
        .user-info-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .user-profile-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .user-avatar-container {
            position: relative;
            flex-shrink: 0;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: 600;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: var(--shadow);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .edit-avatar-btn {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .edit-avatar-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }

        .user-basic-info {
            flex: 1;
            min-width: 0;
        }

        .user-display-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .user-handle-display {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .user-description {
            color: #374151;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .edit-profile-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .edit-profile-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* 编辑资料模态框样式 */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        }

        .profile-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .profile-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-light);
            border-radius: 16px 16px 0 0;
        }

        .profile-modal-header h3 {
            margin: 0;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 4px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .profile-modal-close:hover {
            background: var(--error-color);
            color: white;
        }

        .profile-modal-body {
            padding: 24px;
        }

        .profile-section {
            margin-bottom: 24px;
        }

        .profile-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-input,
        .profile-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
            font-family: inherit;
        }

        .profile-input:focus,
        .profile-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .profile-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* 头像编辑容器 */
        .avatar-edit-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            font-weight: 600;
            overflow: hidden;
            border: 3px solid var(--border-color);
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* 背景图编辑容器 */
        .banner-edit-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .banner-preview {
            width: 100%;
            height: 150px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            background: var(--bg-light);
        }

        .banner-preview:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .banner-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .banner-preview i {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .banner-actions {
            display: flex;
            gap: 8px;
        }

        .profile-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .user-profile-section {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .edit-profile-btn {
                position: static;
                align-self: flex-end;
                margin-top: 12px;
            }

            .avatar-edit-container {
                flex-direction: column;
                align-items: center;
            }

            .banner-actions {
                flex-direction: column;
            }

            .profile-actions {
                flex-direction: column;
            }

            .profile-modal {
                padding: 10px;
            }

            .profile-modal-content {
                max-height: 95vh;
            }
        }

        /* Chat Styles */
        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .chat-message.user {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant {
            background: white;
            color: #374151;
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .chat-message.system {
            background: #fef3c7;
            color: #92400e;
            text-align: center;
            margin: 8px auto;
            font-size: 0.9rem;
            max-width: 60%;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            resize: none;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            line-height: 1.4;
        }

        .chat-send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
        }

        .chat-send-btn:hover {
            background: var(--primary-hover);
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-interrupt-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
            margin-right: 8px;
        }

        .chat-interrupt-btn:hover {
            background: #dc2626;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .connection-status.connected {
            background: #f0fdf4;
            color: var(--success-color);
            border: 1px solid #bbf7d0;
        }

        .connection-status.disconnected {
            background: #fef2f2;
            color: var(--error-color);
            border: 1px solid #fecaca;
        }

        .connection-status.connecting {
            background: #fffbeb;
            color: var(--warning-color);
            border: 1px solid #fed7aa;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Post Form Styles */
        .post-form {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .post-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }

        .char-counter {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .char-counter.warning {
            color: var(--warning-color);
        }

        .char-counter.error {
            color: var(--error-color);
        }

        /* 帖子发布相关样式 */
        .post-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
        }

        .media-buttons {
            display: flex;
            gap: 12px;
        }

        .media-btn {
            background: var(--bg-light);
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
        }

        .media-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .media-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .media-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* 媒体预览样式 */
        .media-preview {
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .images-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .image-preview-item .remove-btn:hover {
            background: var(--error-color);
        }

        .video-preview {
            margin-bottom: 12px;
        }

        .video-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            max-width: 300px;
        }

        .video-preview-item video {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .video-preview-item .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .external-preview {
            margin-bottom: 12px;
        }

        .external-preview-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative;
        }

        .external-preview-item .external-thumb {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-light);
        }

        .external-preview-item .external-info {
            flex: 1;
        }

        .external-preview-item .external-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .external-preview-item .external-desc {
            color: var(--text-light);
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .external-preview-item .external-url {
            color: var(--primary-color);
            font-size: 0.8rem;
            text-decoration: none;
            margin-top: 4px;
            display: block;
        }

        .external-preview-item .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* 上传进度样式 */
        .upload-progress {
            margin: 8px 0;
            padding: 8px;
            background: var(--bg-light);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .upload-progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .upload-progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .upload-progress-text {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Feed 流样式 */
        .feed-container {
            margin-top: 20px;
        }

        .feed-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .feed-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .feed-card-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .feed-card-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .feed-card-author {
            flex: 1;
        }

        .feed-card-author .handle {
            font-weight: 600;
            color: #374151;
        }

        .feed-card-author .did {
            font-size: 0.8rem;
            color: var(--text-light);
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .feed-card-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .feed-card-content {
            line-height: 1.6;
            color: #374151;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }

        .feed-card-media {
            margin: 12px 0;
        }

        .feed-card-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin: 12px 0;
        }

        .feed-card-images img {
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .feed-card-images img:hover {
            transform: scale(1.02);
        }

        .feed-card-video {
            margin: 12px 0;
        }

        .feed-card-video video {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
        }

        .feed-card-external {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin: 12px 0;
            background: white;
        }

        .feed-card-external-content {
            padding: 12px;
        }

        .feed-card-external-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .feed-card-external-desc {
            color: var(--text-light);
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .feed-card-external-url {
            color: var(--primary-color);
            font-size: 0.8rem;
            text-decoration: none;
        }

        .feed-card-external-thumb {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .feed-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .feed-card-tag {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        /* 回复功能样式 */
        .feed-card-reply-info {
            padding: 8px 0;
            color: var(--text-light);
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 12px;
        }

        .feed-card-reply-info i {
            margin-right: 6px;
        }

        .feed-card-actions {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 12px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .action-btn i {
            font-size: 0.8rem;
        }

        /* 回复表单样式 */
        .reply-form-container {
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
            margin-top: 12px;
            background: var(--bg-light);
            border-radius: 8px;
            padding: 16px;
        }

        .reply-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .reply-to-info {
            font-size: 0.9rem;
            color: var(--text-light);
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .reply-textarea {
            min-height: 80px;
            resize: vertical;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .reply-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .reply-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reply-media-buttons {
            display: flex;
            gap: 8px;
        }

        .reply-submit-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .reply-char-counter {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .reply-char-counter.warning {
            color: var(--warning-color);
        }

        .reply-char-counter.error {
            color: var(--error-color);
        }

        /* Thread 模态框样式 */
        .thread-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        }

        .thread-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .thread-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .thread-modal-header h3 {
            margin: 0;
            color: #374151;
        }

        .thread-modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 4px;
        }

        .thread-modal-close:hover {
            color: var(--error-color);
        }

        .thread-content {
            padding: 20px;
        }

        .thread-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 3px solid var(--primary-color);
        }

        .thread-card.is-reply {
            margin-left: 32px;
            border-left-color: var(--text-light);
        }

        .thread-card.is-nested-reply {
            margin-left: 64px;
            border-left-color: var(--warning-color);
        }

        .thread-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .thread-error {
            text-align: center;
            padding: 40px;
            color: var(--error-color);
        }

        /* 加载更多按钮 */
        .load-more-btn {
            width: 100%;
            background: var(--bg-light);
            color: var(--primary-color);
            border: 2px dashed var(--border-color);
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            margin: 20px 0;
            transition: all 0.2s;
        }

        .load-more-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Welcome Animation */
        .welcome-animation {
            text-align: center;
            padding: 60px 20px;
        }

        .welcome-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .welcome-text {
            font-size: 1.2rem;
            color: var(--text-light);
            margin-bottom: 30px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-menu {
                justify-content: center;
            }

            .chat-container {
                height: 400px;
            }

            .chat-message {
                max-width: 90%;
            }

            .feed-card-actions {
                flex-direction: column;
                gap: 8px;
            }

            .action-btn {
                justify-content: center;
                text-align: center;
            }

            .reply-actions {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .reply-media-buttons {
                justify-content: center;
            }

            .reply-submit-actions {
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }

            .thread-modal {
                padding: 10px;
            }

            .thread-modal-content {
                max-height: 95vh;
            }

            .thread-card.is-reply {
                margin-left: 16px;
            }

            .thread-card.is-nested-reply {
                margin-left: 32px;
            }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 聊天消息加载状态 */
        .chat-message.loading {
            opacity: 0.7;
        }

        .loading-spinner {
            color: var(--primary-color);
        }

        .chat-message.completed {
            opacity: 1;
        }

        .chat-message .status {
            font-size: 0.8rem;
            color: var(--text-light);
            font-style: italic;
            margin-left: 8px;
        }

        /* 聊天相关样式 */
        .chat-image-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .chat-image-btn:hover {
            background: #0056b3;
        }

        .chat-interrupt-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .chat-interrupt-btn:hover {
            background: #c82333;
        }

        .chat-interrupt-btn.hidden {
            display: none;
        }

        .chat-message.loading {
            opacity: 0.7;
        }

        .loading-spinner {
            color: #007bff;
            margin-left: 8px;
        }

        .chat-message.completed {
            opacity: 1;
        }

        .chat-message img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 4px;
            display: block;
        }

        .status {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
            margin-left: 8px;
        }

        /* 历史消息样式 */
        .message-timestamp {
            font-size: 0.8em;
            color: #888;
            margin-left: 8px;
            opacity: 0.7;
        }

        .chat-message.system {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            text-align: center;
            font-size: 0.9rem;
            margin: 8px auto;
            max-width: 80%;
        }

        .chat-message.system i {
            margin-right: 6px;
        }

        /* 历史消息加载提示 */
        .history-loading {
            text-align: center;
            padding: 10px;
            color: var(--text-light);
            font-style: italic;
        }

        /* 流式消息样式 */
        .message-icon {
            display: inline-block;
            vertical-align: top;
        }

        .message-content {
            display: inline-block;
            vertical-align: top;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .loading-spinner {
            color: var(--primary-color);
            font-style: italic;
            margin-left: 8px;
        }

        .chat-message.loading .loading-spinner {
            display: inline;
        }

        .chat-message.completed .loading-spinner {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-robot"></i> AvatarAI Social</h1>
            <p id="user-greeting" class="user-greeting hidden">
                <i class="fas fa-user-circle"></i>
                你好 <span id="user-handle"></span>！欢迎来到智能社交平台
            </p>
            <div id="nav-menu" class="nav-menu hidden">
                <button id="refresh-token-btn">
                    <i class="fas fa-sync-alt"></i> 刷新令牌
                </button>
                <button id="logout-btn" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </header>

        <!-- Message Container -->
        <div id="message-container"></div>

        <!-- Login Form -->
        <div id="login-form" class="card hidden">
            <h3><i class="fas fa-key"></i> 使用 atproto 登录</h3>
            <p>提供您的 handle 或 DID 以授权现有 PDS 帐户。<br>您也可以提供 PDS/入口 URL (例如, <code>https://pds.example.com</code>)。</p>

            <form id="oauth-login-form">
                <div class="form-group">
                    <label for="username">
                        <i class="fas fa-at"></i> Handle / DID / PDS URL
                    </label>
                    <input
                        name="username"
                        id="username"
                        placeholder="handle.example.com"
                        style="font-family: 'Monaco', 'Menlo', monospace;"
                        required
                    >
                </div>
                <button type="submit" class="btn" id="oauth-login-btn">
                    <i class="fas fa-sign-in-alt"></i> 登录
                </button>
            </form>

            <div id="login-loading" class="loading">
                <div class="spinner"></div>
                正在处理登录请求...
            </div>
        </div>

        <!-- User Panel -->
        <div id="user-panel" class="hidden">
            <!-- User Info -->
            <div class="card">
                <h3><i class="fas fa-user"></i> 用户信息</h3>
                <div class="user-info-container">
                    <div class="user-profile-section">
                        <div class="user-avatar-container">
                            <div class="user-avatar" id="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <button class="edit-avatar-btn" onclick="showEditProfileModal()">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <div class="user-basic-info">
                            <div class="user-display-name" id="user-display-name">用户名</div>
                            <div class="user-handle-display" id="user-handle-display">@handle</div>
                            <div class="user-description" id="user-description">还没有个人简介</div>
                        </div>
                        <button class="edit-profile-btn" onclick="showEditProfileModal()">
                            <i class="fas fa-edit"></i> 编辑资料
                        </button>
                    </div>
                    <div class="user-info">
                        <p>
                            <strong><i class="fas fa-fingerprint"></i> DID:</strong>
                            <span id="user-did"></span>
                        </p>
                        <p>
                            <strong><i class="fas fa-at"></i> Handle:</strong>
                            <span id="user-handle-full"></span>
                        </p>
                        <p>
                            <strong><i class="fas fa-calendar"></i> 创建时间:</strong>
                            <span id="user-created-at">-</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="main-content">
                <!-- Chat Section -->
                <div class="card">
                    <h3><i class="fas fa-comments"></i> 智能对话</h3>

                    <div id="connection-status" class="connection-status disconnected">
                        <div class="status-indicator"></div>
                        <span id="connection-text">未连接</span>
                    </div>

                    <div class="chat-container">
                        <div id="chat-messages" class="chat-messages">
                            <div class="chat-message system">
                                <i class="fas fa-robot"></i> 欢迎使用 AvatarAI 智能对话！我是你的AI助手，有什么可以帮助你的吗？
                            </div>
                        </div>

                        <div class="chat-input-container">
                            <textarea
                                id="chat-input"
                                class="chat-input"
                                placeholder="输入消息..."
                                rows="1"
                                disabled
                            ></textarea>
                            <button id="chat-interrupt-btn" class="chat-interrupt-btn hidden">
                                <i class="fas fa-stop"></i>
                            </button>
                            <button id="chat-send-btn" class="chat-send-btn" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Post Section -->
                <div class="card">
                    <h3><i class="fas fa-edit"></i> 发布帖子</h3>

                    <form id="post-form" class="post-form">
                        <div class="form-group">
                            <label for="post-content">
                                <i class="fas fa-pen"></i> 分享你的想法
                            </label>
                            <textarea
                                id="post-content"
                                class="post-textarea"
                                placeholder="今天有什么想分享的吗？#标签 @mention https://link.com"
                                maxlength="3000"
                            ></textarea>
                        </div>

                        <!-- 媒体预览区域 -->
                        <div id="media-preview" class="media-preview hidden">
                            <div id="images-preview" class="images-preview"></div>
                            <div id="video-preview" class="video-preview"></div>
                            <div id="external-preview" class="external-preview"></div>
                        </div>

                        <!-- 外部链接输入 -->
                        <div id="external-input" class="form-group hidden">
                            <label for="external-url">
                                <i class="fas fa-link"></i> 外部链接
                            </label>
                            <input
                                id="external-url"
                                type="url"
                                placeholder="输入外部链接URL"
                            >
                            <button type="button" id="add-external-btn" class="btn">
                                <i class="fas fa-plus"></i> 添加链接
                            </button>
                            <button type="button" id="cancel-external-btn" class="btn btn-danger">
                                <i class="fas fa-times"></i> 取消
                            </button>
                        </div>

                        <!-- 帖子工具栏 -->
                        <div class="post-toolbar">
                            <div class="media-buttons">
                                <button type="button" id="add-images-btn" class="media-btn" title="添加图片">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button type="button" id="add-video-btn" class="media-btn" title="添加视频">
                                    <i class="fas fa-video"></i>
                                </button>
                                <button type="button" id="add-link-btn" class="media-btn" title="添加外部链接">
                                    <i class="fas fa-link"></i>
                                </button>
                            </div>

                            <div class="post-actions">
                                <div class="char-counter">
                                    <span id="char-count">0</span>/3000
                                </div>
                                <button type="submit" class="btn btn-success" id="post-btn">
                                    <i class="fas fa-share"></i> 发布
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- 隐藏的文件输入 -->
                    <input type="file" id="images-input" accept="image/*" multiple style="display: none;">
                    <input type="file" id="video-input" accept="video/*" style="display: none;">
                </div>
            </div>

            <!-- Feed 流显示 -->
            <div class="feed-container">
                <div class="card">
                    <h3><i class="fas fa-stream"></i> 动态流</h3>
                    <div id="feed-list">
                        <div class="welcome-animation">
                            <div class="welcome-icon">
                                <i class="fas fa-newspaper"></i>
                            </div>
                            <div class="welcome-text">
                                暂无动态，发布第一条帖子吧！
                            </div>
                        </div>
                    </div>
                    <button id="load-more-btn" class="load-more-btn hidden">
                        <i class="fas fa-plus"></i> 加载更多
                    </button>
                </div>
            </div>
        </div>

        <!-- Welcome Message -->
        <div id="welcome-message" class="card">
            <div class="welcome-animation">
                <div class="welcome-icon">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="welcome-text">
                    欢迎来到 AvatarAI Social！<br>
                    登录以开始你的智能社交之旅
                </div>
                <button id="welcome-login-btn" class="btn">
                    <i class="fas fa-sign-in-alt"></i> 立即登录
                </button>
            </div>
        </div>

        <!-- OAuth Callback Handler -->
        <div id="oauth-callback-handler" class="card hidden">
            <h3><i class="fas fa-cog fa-spin"></i> 正在完成登录...</h3>
            <div class="loading show">
                <div class="spinner"></div>
                正在处理授权码，请稍候...
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="profile-modal hidden">
            <div class="profile-modal-content">
                <div class="profile-modal-header">
                    <h3><i class="fas fa-user-edit"></i> 编辑个人资料</h3>
                    <button class="profile-modal-close" onclick="hideEditProfileModal()">&times;</button>
                </div>
                <div class="profile-modal-body">
                    <form id="edit-profile-form" enctype="multipart/form-data">
                        <!-- Avatar Section -->
                        <div class="profile-section">
                            <label class="profile-label">
                                <i class="fas fa-image"></i> 头像
                            </label>
                            <div class="avatar-edit-container">
                                <div class="avatar-preview" id="avatar-preview">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="avatar-actions">
                                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                                    <button type="button" class="btn" onclick="selectAvatar()">
                                        <i class="fas fa-upload"></i> 选择头像
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="removeAvatar()">
                                        <i class="fas fa-trash"></i> 移除
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Banner Section -->
                        <div class="profile-section">
                            <label class="profile-label">
                                <i class="fas fa-image"></i> 背景图
                            </label>
                            <div class="banner-edit-container">
                                <div class="banner-preview" id="banner-preview">
                                    <i class="fas fa-mountain"></i>
                                    <span>点击或拖拽上传背景图</span>
                                </div>
                                <div class="banner-actions">
                                    <input type="file" id="banner-input" accept="image/*" style="display: none;">
                                    <button type="button" class="btn" onclick="selectBanner()">
                                        <i class="fas fa-upload"></i> 选择背景
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="removeBanner()">
                                        <i class="fas fa-trash"></i> 移除
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Display Name -->
                        <div class="profile-section">
                            <label for="edit-display-name" class="profile-label">
                                <i class="fas fa-user-tag"></i> 显示名称
                            </label>
                            <input
                                type="text"
                                id="edit-display-name"
                                maxlength="50"
                                placeholder="输入你的显示名称"
                                class="profile-input"
                            >
                            <div class="char-counter">
                                <span id="display-name-count">0</span>/50
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="profile-section">
                            <label for="edit-description" class="profile-label">
                                <i class="fas fa-align-left"></i> 个人简介
                            </label>
                            <textarea
                                id="edit-description"
                                maxlength="300"
                                rows="4"
                                placeholder="介绍一下你自己..."
                                class="profile-textarea"
                            ></textarea>
                            <div class="char-counter">
                                <span id="description-count">0</span>/300
                            </div>
                        </div>

                        <!-- Upload Progress -->
                        <div id="profile-upload-progress" class="upload-progress hidden">
                            <div class="upload-progress-bar">
                                <div class="upload-progress-fill" id="profile-progress-fill"></div>
                            </div>
                            <div class="upload-progress-text" id="profile-progress-text">上传中...</div>
                        </div>

                        <!-- Actions -->
                        <div class="profile-actions">
                            <button type="button" class="btn btn-danger" onclick="hideEditProfileModal()">
                                <i class="fas fa-times"></i> 取消
                            </button>
                            <button type="submit" class="btn btn-success" id="save-profile-btn">
                                <i class="fas fa-save"></i> 保存
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let accessToken = null;
        let chatWebSocket = null;
        let isConnecting = false;
        let currentAgentMessageId = null; // 当前AI消息ID，用于中断
        let tokenRefreshTimer = null; // 令牌刷新定时器

        // 帖子发布相关变量
        let postData = {
            images: [],
            video: null,
            external: null
        };
        let feedCursor = null; // Feed分页游标

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否有保存的访问令牌 - 优先从localStorage获取，然后从cookie
            accessToken = getStoredToken();
            if (accessToken) {
                // 尝试从localStorage获取用户信息
                const storedUser = getStoredUser();
                if (storedUser) {
                    currentUser = storedUser;
                    setupTokenRefresh(); // 设置自动刷新令牌
                    checkTokenExpiry(); // 检查令牌是否需要刷新
                    showUserPanel();
                    connectWebSocket();
                } else {
                    // 如果没有存储的用户信息，重新获取
                    fetchCurrentUser();
                }
            } else {
                showWelcome();
            }

            // 处理OAuth回调
            handleOAuthCallback();

            // 绑定事件 - 确保元素存在后再绑定
            const oauthLoginBtn = document.getElementById('oauth-login-btn');
            if (oauthLoginBtn) {
                oauthLoginBtn.addEventListener('click', handleOAuthLogin);
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            const refreshTokenBtn = document.getElementById('refresh-token-btn');
            if (refreshTokenBtn) {
                refreshTokenBtn.addEventListener('click', refreshAccessToken);
            }

            const chatSendBtn = document.getElementById('chat-send-btn');
            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', sendChatMessage);
            }

            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', handleChatKeyPress);
                chatInput.addEventListener('input', autoResizeTextarea);
                // 初始化聊天输入框
                autoResizeTextarea({ target: chatInput });
            }

            // 添加中断按钮事件
            const interruptBtn = document.getElementById('chat-interrupt-btn');
            if (interruptBtn) {
                interruptBtn.addEventListener('click', interruptAIResponse);
            }

            // 绑定欢迎页面登录按钮
            const welcomeLoginBtn = document.getElementById('welcome-login-btn');
            if (welcomeLoginBtn) {
                welcomeLoginBtn.addEventListener('click', showLoginForm);
            }

            // 绑定表单提交事件
            const oauthLoginForm = document.getElementById('oauth-login-form');
            if (oauthLoginForm) {
                oauthLoginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleOAuthLogin();
                });
            }

            // 绑定帖子发布相关事件
            bindPostEvents();

            // 绑定模态框外部点击关闭事件
            bindModalEvents();
        });

        function bindModalEvents() {
            // 点击模态框外部关闭
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('profile-modal')) {
                    hideEditProfileModal();
                }
            });
        }

        // OAuth 处理
        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                showMessage('OAuth 认证失败: ' + decodeURIComponent(error), 'error');
                showWelcome();
                // 清理URL参数
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (code) {
                showElement('oauth-callback-handler');

                // 使用code换取token
                fetch('/api/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: code })
                })
                    .then(response => response.json())
                    .then(data => {
                        hideElement('oauth-callback-handler');
                        if (data.access_token) {
                            accessToken = data.access_token;
                            // 保存到localStorage和cookie
                                                        storeToken(accessToken);
                            storeRefreshToken(data.refresh_token);

                            // 创建用户对象并存储
                            const user = {
                                did: data.did,
                                handle: data.handle
                            };
                            currentUser = user;
                            storeUser(user);

                            // 设置自动刷新令牌
                            setupTokenRefresh();

                            showUserPanel();
                            connectWebSocket();
                            window.history.replaceState({}, document.title, window.location.pathname);
                            showMessage('登录成功！', 'success');
                        } else {
                            showMessage('OAuth 认证失败: ' + (data.error || '未知错误'), 'error');
                            showWelcome();
                        }
                    })
                    .catch(error => {
                        hideElement('oauth-callback-handler');
                        console.error('OAuth callback error:', error);
                        showMessage('OAuth 认证失败: ' + error.message, 'error');
                        showWelcome();
                    });
            }
        }

        function handleOAuthLogin() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showMessage('请输入用户名', 'error');
                return;
            }

            showLoading('login-loading');

            // 直接提交表单到后端，让后端处理重定向
            // 这样可以避免CORS问题，因为OAuth授权流程需要浏览器重定向
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/api/oauth/signin?platform=web';

            const usernameInput = document.createElement('input');
            usernameInput.type = 'hidden';
            usernameInput.name = 'username';
            usernameInput.value = username;

            form.appendChild(usernameInput);
            document.body.appendChild(form);

            // 提交表单，这将触发浏览器重定向到OAuth授权服务器
            form.submit();
        }

        function handleLogout() {
            if (accessToken) {
                fetch('/api/oauth/logout', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                })
                .then(() => {
                    clearStoredAuth();
                    disconnectWebSocket();
                    showWelcome();
                    showMessage('已成功登出', 'success');
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    clearStoredAuth();
                    disconnectWebSocket();
                    showWelcome();
                    showMessage('已成功登出', 'success');
                });
            } else {
                clearStoredAuth();
                showWelcome();
            }
        }

        function fetchCurrentUser() {
            if (!accessToken) {
                showWelcome();
                return;
            }

            fetch('/api/avatar/profile', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('获取用户信息失败');
            })
            .then(data => {
                // 处理头像和背景图URL
                if (data.avatar && !data.avatar.startsWith('http')) {
                    data.avatar = `/api/blobs?id=${data.avatar}`;
                }
                if (data.banner && !data.banner.startsWith('http')) {
                    data.banner = `/api/blobs?id=${data.banner}`;
                }

                currentUser = data;
                storeUser(data); // 存储用户信息
                setupTokenRefresh(); // 设置自动刷新令牌
                showUserPanel();
                connectWebSocket();
            })
            .catch(error => {
                console.error('获取用户信息失败:', error);
                clearStoredAuth();
                showWelcome();
            });
        }

        // 自动调整文本框高度
        function autoResizeTextarea(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // WebSocket 连接管理
        function connectWebSocket() {
            if (!accessToken || !currentUser || isConnecting) {
                return;
            }

            isConnecting = true;
            updateConnectionStatus('connecting', '连接中...');

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/chat/stream`;

            chatWebSocket = new WebSocket(wsUrl);

            chatWebSocket.onopen = function(event) {
                isConnecting = false;
                updateConnectionStatus('connected', '已连接');
                enableChatInput();
                console.log('WebSocket 连接已建立');
            };

            chatWebSocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleChatMessage(data);
                } catch (error) {
                    console.error('解析 WebSocket 消息失败:', error);
                }
            };

            chatWebSocket.onclose = function(event) {
                isConnecting = false;
                updateConnectionStatus('disconnected', '连接已断开');
                disableChatInput();
                console.log('WebSocket 连接已关闭:', event.code, event.reason);

                // 如果不是主动关闭，尝试重连
                if (event.code !== 1000 && currentUser) {
                    setTimeout(() => {
                        if (currentUser) {
                            connectWebSocket();
                        }
                    }, 3000);
                }
            };

            chatWebSocket.onerror = function(error) {
                isConnecting = false;
                updateConnectionStatus('disconnected', '连接错误');
                disableChatInput();
                console.error('WebSocket 错误:', error);
            };
        }

        function disconnectWebSocket() {
            if (chatWebSocket) {
                chatWebSocket.close(1000, 'User logout');
                chatWebSocket = null;
            }
            updateConnectionStatus('disconnected', '未连接');
            disableChatInput();
        }

        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connection-status');
            const textElement = document.getElementById('connection-text');

            statusElement.className = `connection-status ${status}`;
            textElement.textContent = text;
        }

        function enableChatInput() {
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-send-btn').disabled = false;
        }

        function disableChatInput() {
            document.getElementById('chat-input').disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
        }

        // 聊天功能
        function handleChatKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message || !chatWebSocket || chatWebSocket.readyState !== WebSocket.OPEN) {
                return;
            }

            // 显示用户消息
            addChatMessage(message, 'user');

            // 发送到服务器
            const chatEvent = {
                eventId: generateUUID(),
                eventType: 'message.send',
                event: {
                    roomId: 'default',
                    msgType: 1, // TEXT
                    body: {
                        text: message
                    },
                    receiverId: 'assistant',
                    senderId: currentUser.did,
                    threadId: 'default',
                    senderAt: Date.now()
                }
            };

            chatWebSocket.send(JSON.stringify(chatEvent));
            input.value = '';
            autoResizeTextarea({ target: input });
        }

        function handleChatMessage(data) {
            console.log('收到聊天消息:', data);

            switch (data.eventType) {
                case 'message_received':
                    handleMessageReceived(data.event);
                    break;
                case 'agent_message.created':
                    handleAgentMessageCreated(data.event);
                    break;
                case 'agent_message.in_progress':
                    handleAgentMessageInProgress(data.event);
                    break;
                case 'agent_message.output_item.added':
                    handleOutputItemAdded(data.event);
                    break;
                case 'agent_message.content_part.added':
                    handleContentPartAdded(data.event);
                    break;
                case 'agent_message.output_text.delta':
                    handleTextDelta(data.event);
                    break;
                case 'agent_message.output_text.done':
                    handleTextDone(data.event);
                    break;
                case 'agent_message.content_part.done':
                    handleContentPartDone(data.event);
                    break;
                case 'agent_message.output_item.done':
                    handleOutputItemDone(data.event);
                    break;
                case 'agent_message.completed':
                    handleAgentMessageCompleted(data.event);
                    break;
                case 'agent_message.failed':
                    handleAgentMessageFailed(data.event);
                    break;
                case 'agent_message.incomplete':
                    handleAgentMessageIncomplete(data.event);
                    break;
                case 'error':
                    handleErrorEvent(data.event);
                    break;
                default:
                    console.log('未处理的事件类型:', data.eventType);
            }
        }

        // 处理各种聊天事件
        function handleMessageReceived(event) {
            if (event.message && event.message.content) {
                const content = event.message.content;
                const msgType = event.message.msgType;

                switch (msgType) {
                    case 1: // TEXT
                        if (content.text) {
                            addChatMessage(content.text, 'assistant');
                        }
                        break;
                    case 3: // IMAGE
                        if (content.imageUrl || content.imageCid) {
                            const imageUrl = content.imageUrl || `/api/blobs?id=${content.imageCid}`;
                            const imageHtml = `<img src="${imageUrl}" alt="${content.alt || '图片'}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                            addChatMessage(imageHtml, 'assistant', null, false, true);
                        }
                        break;
                    default:
                        console.log('未处理的消息类型:', msgType);
                }
            }
        }

        function handleAgentMessageCreated(event) {
            const agentMessage = event.agentMessage;
            console.log('AI消息创建:', agentMessage);

            // 保存当前AI消息ID，用于中断
            currentAgentMessageId = agentMessage.id;
            showInterruptButton();

            // 创建一个占位符消息，用于后续更新
            const messageId = agentMessage.id;
            createStreamingMessage(messageId);
        }

        function createStreamingMessage(messageId) {
            console.log('创建流式消息容器:', messageId);

            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message assistant loading';
            messageDiv.setAttribute('data-message-id', messageId);

            // 创建图标容器
            const iconContainer = document.createElement('span');
            iconContainer.className = 'message-icon';
            iconContainer.innerHTML = '<i class="fas fa-robot"></i> ';

            // 创建内容容器
            const contentContainer = document.createElement('span');
            contentContainer.className = 'message-content';

            // 创建加载指示器
            const loadingSpinner = document.createElement('span');
            loadingSpinner.className = 'loading-spinner';
            loadingSpinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在思考...';

            messageDiv.appendChild(iconContainer);
            messageDiv.appendChild(contentContainer);
            messageDiv.appendChild(loadingSpinner);

            messagesContainer.appendChild(messageDiv);
            scrollChatToBottom();

            console.log('流式消息容器已创建:', messageDiv);
        }

        function handleAgentMessageInProgress(event) {
            const agentMessage = event.agentMessage;
            console.log('AI消息处理中:', agentMessage);

            // 更新加载状态
            const messageElement = document.querySelector(`[data-message-id="${agentMessage.id}"]`);
            if (messageElement) {
                const loadingSpinner = messageElement.querySelector('.loading-spinner');
                if (loadingSpinner) {
                    loadingSpinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在思考...';
                }
            }
        }

        function handleOutputItemAdded(event) {
            const { outputIndex, item } = event;
            console.log('输出项添加:', item);

            if (item.type === 'message') {
                // 为新的输出消息创建容器
                const messageId = item.id;
                if (!document.querySelector(`[data-message-id="${messageId}"]`)) {
                    // 创建新的流式消息容器
                    createStreamingMessage(messageId);
                }
            }
        }

        function handleContentPartAdded(event) {
            const { itemId, outputIndex, contentIndex, part } = event;
            console.log('内容部分添加:', part);

            if (part.type === 'output_text') {
                // 为文本内容创建容器
                const messageElement = document.querySelector(`[data-message-id="${itemId}"]`);
                if (messageElement) {
                    // 隐藏加载指示器
                    const loadingSpinner = messageElement.querySelector('.loading-spinner');
                    if (loadingSpinner) {
                        loadingSpinner.style.display = 'none';
                    }

                    // 在内容容器中创建文本容器
                    const contentContainer = messageElement.querySelector('.message-content');
                    if (contentContainer) {
                        const textContainer = document.createElement('span');
                        textContainer.setAttribute('data-content-index', contentIndex);
                        contentContainer.appendChild(textContainer);
                    }
                }
            }
        }

        function handleTextDelta(event) {
            const { itemId, outputIndex, contentIndex, delta } = event;
            console.log('收到文本增量:', { itemId, contentIndex, delta });

            // 找到对应的消息元素
            const messageElement = document.querySelector(`[data-message-id="${itemId}"]`);
            if (messageElement) {
                // 隐藏加载指示器（如果存在）
                const loadingSpinner = messageElement.querySelector('.loading-spinner');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }

                // 获取或创建内容容器
                const contentContainer = messageElement.querySelector('.message-content');
                if (contentContainer) {
                    // 查找或创建特定内容索引的容器
                    let textContainer = contentContainer.querySelector(`[data-content-index="${contentIndex}"]`);
                    if (!textContainer) {
                        textContainer = document.createElement('span');
                        textContainer.setAttribute('data-content-index', contentIndex);
                        contentContainer.appendChild(textContainer);
                    }

                    // 追加文本增量
                    textContainer.textContent += delta;
                } else {
                    // 如果没有内容容器，直接在消息元素中查找
                    let textContainer = messageElement.querySelector(`[data-content-index="${contentIndex}"]`);
                    if (!textContainer) {
                        textContainer = document.createElement('span');
                        textContainer.setAttribute('data-content-index', contentIndex);
                        messageElement.appendChild(textContainer);
                    }
                    textContainer.textContent += delta;
                }

                // 滚动到底部
                scrollChatToBottom();
            }
        }

        function handleTextDone(event) {
            const { itemId, outputIndex, contentIndex, text } = event;
            console.log('文本完成:', text);

            // 确保最终文本是完整的
            const messageElement = document.querySelector(`[data-message-id="${itemId}"]`);
            if (messageElement) {
                // 隐藏加载指示器
                const loadingSpinner = messageElement.querySelector('.loading-spinner');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }

                // 在内容容器中设置最终文本
                const contentContainer = messageElement.querySelector('.message-content');
                if (contentContainer) {
                    let textContainer = contentContainer.querySelector(`[data-content-index="${contentIndex}"]`);
                    if (!textContainer) {
                        textContainer = document.createElement('span');
                        textContainer.setAttribute('data-content-index', contentIndex);
                        contentContainer.appendChild(textContainer);
                    }
                    textContainer.textContent = text;
                } else {
                    // 备用方案：直接在消息元素中设置
                    let textContainer = messageElement.querySelector(`[data-content-index="${contentIndex}"]`);
                    if (!textContainer) {
                        textContainer = document.createElement('span');
                        textContainer.setAttribute('data-content-index', contentIndex);
                        messageElement.appendChild(textContainer);
                    }
                    textContainer.textContent = text;
                }
            }
        }

        function handleContentPartDone(event) {
            const { itemId, outputIndex, contentIndex, part } = event;
            console.log('内容部分完成:', part);
        }

        function handleOutputItemDone(event) {
            const { outputIndex, item } = event;
            console.log('输出项完成:', item);

            // 移除加载状态
            const messageElement = document.querySelector(`[data-message-id="${item.id}"]`);
            if (messageElement) {
                messageElement.classList.remove('loading');
            }
        }

        function handleAgentMessageCompleted(event) {
            const agentMessage = event.agentMessage;
            console.log('AI消息完成:', agentMessage);

            // 清除当前AI消息ID并隐藏中断按钮
            currentAgentMessageId = null;
            hideInterruptButton();

            // 移除所有加载状态
            const messageElement = document.querySelector(`[data-message-id="${agentMessage.id}"]`);
            if (messageElement) {
                messageElement.classList.remove('loading');
                messageElement.classList.add('completed');

                // 完全隐藏加载指示器
                const loadingSpinner = messageElement.querySelector('.loading-spinner');
                if (loadingSpinner) {
                    loadingSpinner.remove();
                }
            }
        }

        function handleAgentMessageFailed(event) {
            const agentMessage = event.agentMessage;
            console.log('AI消息失败:', agentMessage);

            // 清除当前AI消息ID并隐藏中断按钮
            currentAgentMessageId = null;
            hideInterruptButton();

            const errorMsg = agentMessage.error ? agentMessage.error.message : '处理失败';
            addChatMessage(`错误: ${errorMsg}`, 'system');
        }

        function handleAgentMessageIncomplete(event) {
            const agentMessage = event.agentMessage;
            console.log('AI消息不完整:', agentMessage);

            // 清除当前AI消息ID并隐藏中断按钮
            currentAgentMessageId = null;
            hideInterruptButton();

            addChatMessage('响应被中断或不完整', 'system');
        }

        function handleErrorEvent(event) {
            const errorMsg = event.message || '发生未知错误';
            addChatMessage(`错误: ${errorMsg}`, 'system');
        }

        function addChatMessage(text, type, messageId = null, isLoading = false, isHtml = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;

            if (messageId) {
                messageDiv.setAttribute('data-message-id', messageId);
            }

            if (isLoading) {
                messageDiv.classList.add('loading');
            }

            let iconHtml = '';
            if (type === 'user') {
                iconHtml = '<i class="fas fa-user"></i> ';
            } else if (type === 'assistant') {
                iconHtml = '<i class="fas fa-robot"></i> ';
            } else {
                iconHtml = '<i class="fas fa-info-circle"></i> ';
            }

            if (isHtml) {
                messageDiv.innerHTML = iconHtml + text;
            } else {
                messageDiv.innerHTML = iconHtml + escapeHtml(text);
            }

            if (isLoading) {
                const loadingSpinner = document.createElement('span');
                loadingSpinner.className = 'loading-spinner';
                loadingSpinner.innerHTML = ' <i class="fas fa-spinner fa-spin"></i>';
                messageDiv.appendChild(loadingSpinner);
            }

            messagesContainer.appendChild(messageDiv);
            scrollChatToBottom();
        }

        function updateChatMessageStatus(messageId, status) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                let statusElement = messageElement.querySelector('.status');
                if (!statusElement) {
                    statusElement = document.createElement('span');
                    statusElement.className = 'status';
                    messageElement.appendChild(statusElement);
                }
                statusElement.textContent = status;
            }
        }

        function scrollChatToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showInterruptButton() {
            const interruptBtn = document.getElementById('chat-interrupt-btn');
            if (interruptBtn) {
                interruptBtn.classList.remove('hidden');
            }
        }

        function hideInterruptButton() {
            const interruptBtn = document.getElementById('chat-interrupt-btn');
            if (interruptBtn) {
                interruptBtn.classList.add('hidden');
            }
        }

        function interruptAIResponse() {
            if (!currentAgentMessageId || !chatWebSocket || chatWebSocket.readyState !== WebSocket.OPEN) {
                return;
            }

            const interruptEvent = {
                eventId: generateUUID(),
                eventType: 'agent_message.interrupt',
                event: {
                    agentMessageId: currentAgentMessageId
                }
            };

            chatWebSocket.send(JSON.stringify(interruptEvent));
            console.log('发送中断请求:', currentAgentMessageId);

            // 立即隐藏中断按钮
            hideInterruptButton();
        }

        // 加载历史消息
        function loadChatHistory() {
            if (!accessToken) {
                console.log('未登录，无法加载历史消息');
                return;
            }

            const roomId = 'default';
            const threadId = 'default';
            const limit = 20;

            // 显示加载提示
            const messagesContainer = document.getElementById('chat-messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'history-loading';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载历史消息...';
            messagesContainer.appendChild(loadingDiv);

            fetch(`/api/messages/history?roomId=${roomId}&threadId=${threadId}&limit=${limit}`, {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error(`获取历史消息失败: ${response.status} ${response.statusText}`);
            })
            .then(data => {
                console.log('历史消息响应:', data);
                // 移除加载提示
                loadingDiv.remove();

                if (data.messages && data.messages.length > 0) {
                    displayHistoryMessages(data.messages);
                    console.log(`成功加载 ${data.messages.length} 条历史消息`);
                } else {
                    console.log('没有历史消息');
                    addChatMessage('📝 暂无历史消息', 'system');
                }
            })
            .catch(error => {
                console.error('加载历史消息失败:', error);
                // 移除加载提示
                loadingDiv.remove();
                addChatMessage(`❌ 加载历史消息失败: ${error.message}`, 'system');
            });
        }

        function displayHistoryMessages(messages) {
            const messagesContainer = document.getElementById('chat-messages');

            // 清空现有消息（除了欢迎消息）
            const welcomeMessage = messagesContainer.querySelector('.chat-message.system');
            messagesContainer.innerHTML = '';
            if (welcomeMessage) {
                messagesContainer.appendChild(welcomeMessage);
            }

            if (!messages || messages.length === 0) {
                console.log('没有历史消息');
                return;
            }

            console.log(`加载 ${messages.length} 条历史消息`);

            // 按时间顺序排序（最旧的在前）- 使用senderAt或createdAt
            const sortedMessages = messages.sort((a, b) => {
                const timeA = a.senderAt || a.createdAt || 0;
                const timeB = b.senderAt || b.createdAt || 0;
                return timeA - timeB;
            });

            sortedMessages.forEach((message, index) => {
                console.log(`处理历史消息 ${index + 1}:`, {
                    id: message.id,
                    msgType: message.msgType,
                    senderId: message.senderId,
                    senderAt: new Date(message.senderAt).toLocaleString(),
                    content: message.content
                });
                displayHistoryMessage(message);
            });

            scrollChatToBottom();
        }

        function displayHistoryMessage(message) {
            let content = '';
            let type = 'user';
            let isHtml = false;

            // 根据发送者确定消息类型
            if (message.senderId === currentUser?.did) {
                type = 'user';
            } else {
                type = 'assistant';
            }

            // 解析消息内容
            if (message.content) {
                switch (message.msgType) {
                    case 1: // TEXT
                        content = message.content.text || '';
                        break;
                    case 3: // IMAGE
                        if (message.content.imageUrl || message.content.imageCid) {
                            const imageUrl = message.content.imageUrl || `/api/blobs?id=${message.content.imageCid}`;
                            content = `<img src="${imageUrl}" alt="${message.content.alt || '图片'}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                            isHtml = true;
                        } else {
                            content = `[图片] ${message.content.alt || ''}`;
                        }
                        break;
                                        case 9: // AGENT MESSAGE
                        type = 'assistant';
                        if (message.content.message) {
                            const agentMessage = message.content.message;

                            console.log('处理AI消息:', agentMessage);

                            // 检查消息状态
                            if (agentMessage.status === 'incomplete') {
                                // 处理不完整的消息
                                if (agentMessage.error) {
                                    content = `❌ 错误: ${agentMessage.error.message || '处理失败'}`;
                                    type = 'system';
                                } else if (agentMessage.interruptType === 2) {
                                    content = '⚠️ 消息被中断';
                                    type = 'system';
                                } else {
                                    content = '⚠️ 消息不完整';
                                    type = 'system';
                                }
                            } else if (agentMessage.status === 'failed') {
                                // 处理失败的消息
                                const errorMsg = agentMessage.error ? agentMessage.error.message : '处理失败';
                                content = `❌ 处理失败: ${errorMsg}`;
                                type = 'system';
                            } else if (agentMessage.altText && agentMessage.altText.trim()) {
                                // 使用altText作为显示内容
                                content = agentMessage.altText;
                            } else if (agentMessage.messageItems && agentMessage.messageItems.length > 0) {
                                // 从messageItems中提取文本内容
                                const textContents = [];
                                agentMessage.messageItems.forEach(item => {
                                    if (item.content && Array.isArray(item.content)) {
                                        item.content.forEach(contentPart => {
                                            if (contentPart.type === 'output_text' && contentPart.text) {
                                                textContents.push(contentPart.text);
                                            }
                                        });
                                    }
                                });
                                content = textContents.join('') || '🤖 [AI消息无内容]';
                            } else {
                                content = '🤖 [AI消息无内容]';
                            }
                        } else {
                            content = '🤖 [AI消息格式错误]';
                        }
                        break;
                    default:
                        content = `[不支持的消息类型: ${message.msgType}]`;
                        type = 'system';
                }
            }

            if (content) {
                const timestamp = message.senderAt || message.createdAt;
                addHistoryChatMessage(content, type, isHtml, timestamp);
            }
        }

                function addHistoryChatMessage(content, type, isHtml = false, timestamp = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;

            let iconHtml = '';
            if (type === 'user') {
                iconHtml = '<i class="fas fa-user"></i> ';
            } else if (type === 'assistant') {
                iconHtml = '<i class="fas fa-robot"></i> ';
            } else {
                iconHtml = '<i class="fas fa-info-circle"></i> ';
            }

            let timestampHtml = '';
            if (timestamp) {
                const date = new Date(timestamp);
                const timeStr = date.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                timestampHtml = `<span class="message-timestamp" style="font-size: 0.8em; color: #888; margin-left: 8px;">${timeStr}</span>`;
            }

            if (isHtml) {
                messageDiv.innerHTML = iconHtml + content + timestampHtml;
            } else {
                messageDiv.innerHTML = iconHtml + escapeHtml(content) + timestampHtml;
            }

            messagesContainer.appendChild(messageDiv);
        }

        // 图片上传和发送功能
        function setupImageUpload() {
            // 检查是否已经设置过
            if (document.querySelector('.chat-image-btn')) {
                return;
            }

            // 创建隐藏的文件输入
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            // 添加图片发送按钮
            const chatInputContainer = document.querySelector('.chat-input-container');
            const imageButton = document.createElement('button');
            imageButton.className = 'chat-image-btn';
            imageButton.innerHTML = '<i class="fas fa-image"></i>';
            imageButton.title = '发送图片';
            imageButton.onclick = () => fileInput.click();

            chatInputContainer.insertBefore(imageButton, document.getElementById('chat-send-btn'));

            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadAndSendImage(file);
                }
                fileInput.value = ''; // 清空文件输入
            };
        }

        function uploadAndSendImage(file) {
            if (!chatWebSocket || chatWebSocket.readyState !== WebSocket.OPEN) {
                showMessage('WebSocket未连接', 'error');
                return;
            }

            // 显示上传中的消息
            addChatMessage('[正在上传图片...]', 'user');

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/blobs', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('图片上传失败');
            })
            .then(data => {
                console.log('图片上传成功:', data);

                // 发送图片消息
                const chatEvent = {
                    eventId: generateUUID(),
                    eventType: 'message.send',
                    event: {
                        roomId: 'default',
                        msgType: 3, // IMAGE
                        body: {
                            imageCid: data.cid,
                            width: data.width || 0,
                            height: data.height || 0,
                            alt: file.name
                        },
                        receiverId: 'assistant',
                        senderId: currentUser.did,
                        threadId: 'default',
                        senderAt: Date.now()
                    }
                };

                chatWebSocket.send(JSON.stringify(chatEvent));

                // 更新最后一条消息显示实际图片
                const messages = document.querySelectorAll('.chat-message.user');
                const lastMessage = messages[messages.length - 1];
                if (lastMessage && lastMessage.textContent.includes('[正在上传图片...]')) {
                    const imageUrl = data.url || `/api/blobs?id=${data.id}`;
                    lastMessage.innerHTML = `<i class="fas fa-user"></i> <img src="${imageUrl}" alt="${file.name}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                }
            })
            .catch(error => {
                console.error('图片上传失败:', error);
                showMessage('图片上传失败: ' + error.message, 'error');

                // 移除上传中的消息
                const messages = document.querySelectorAll('.chat-message.user');
                const lastMessage = messages[messages.length - 1];
                if (lastMessage && lastMessage.textContent.includes('[正在上传图片...]')) {
                    lastMessage.remove();
                }
            });
        }

        // UI 辅助函数
        function showWelcome() {
            hideElement('user-panel');
            hideElement('login-form');
            hideElement('oauth-callback-handler');
            hideElement('user-greeting');
            hideElement('nav-menu');
            showElement('welcome-message');
        }

        function showLoginForm() {
            hideElement('user-panel');
            hideElement('welcome-message');
            hideElement('oauth-callback-handler');
            hideElement('user-greeting');
            hideElement('nav-menu');
            showElement('login-form');
            document.getElementById('username').focus();
        }

        function showUserPanel() {
            hideElement('login-form');
            hideElement('welcome-message');
            hideElement('oauth-callback-handler');
            showElement('user-panel');
            showElement('user-greeting');
            showElement('nav-menu');

            if (currentUser) {
                updateUserDisplay(currentUser);

                // 设置图片上传功能
                setupImageUpload();

                // 加载历史消息
                setTimeout(() => {
                    loadChatHistory();
                }, 1000);

                // 加载Feed数据
                setTimeout(() => {
                    loadFeedData(true);
                }, 1500);
            }
        }

        function updateUserDisplay(user) {
            // 基本信息
            document.getElementById('user-did').textContent = user.did;
            document.getElementById('user-handle-full').textContent = '@' + user.handle;
            document.getElementById('user-handle').textContent = '@' + user.handle;

            // 显示名称
            const displayName = user.displayName || user.handle || '用户';
            document.getElementById('user-display-name').textContent = displayName;
            document.getElementById('user-handle-display').textContent = '@' + user.handle;

            // 个人简介
            const description = user.description || '还没有个人简介';
            document.getElementById('user-description').textContent = description;

            // 头像
            const userAvatar = document.getElementById('user-avatar');
            if (user.avatar) {
                userAvatar.innerHTML = `<img src="${user.avatar}" alt="${displayName}">`;
            } else {
                userAvatar.innerHTML = `<i class="fas fa-user"></i>`;
                userAvatar.style.background = getAvatarColor(user.handle);
            }

            // 创建时间
            if (user.createdAt) {
                const createdDate = new Date(user.createdAt * 1000);
                document.getElementById('user-created-at').textContent = createdDate.toLocaleDateString('zh-CN');
            }
        }

        function getAvatarColor(handle) {
            // 根据handle生成一个一致的颜色
            let hash = 0;
            for (let i = 0; i < handle.length; i++) {
                hash = handle.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colors = [
                '#6366f1', '#8b5cf6', '#06b6d4', '#10b981',
                '#f59e0b', '#ef4444', '#ec4899', '#84cc16'
            ];
            return colors[Math.abs(hash) % colors.length];
        }

        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showLoading(id) {
            document.getElementById(id).classList.add('show');
        }

        function hideLoading(id) {
            document.getElementById(id).classList.remove('show');
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            let icon = 'fas fa-info-circle';
            if (type === 'error') icon = 'fas fa-exclamation-triangle';
            else if (type === 'success') icon = 'fas fa-check-circle';
            else if (type === 'warning') icon = 'fas fa-exclamation-circle';

            messageDiv.innerHTML = `<i class="${icon}"></i> ${escapeHtml(message)}`;
            container.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // 工具函数
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function deleteCookie(name) {
            document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        }

        // localStorage 相关函数
        function getStoredToken() {
            // 优先从localStorage获取，然后从cookie
            let token = localStorage.getItem('avatarai_access_token');
            if (!token) {
                token = getCookie('access_token') || getCookie('avatarai_token');
            }
            return token;
        }

        function storeToken(token) {
            localStorage.setItem('avatarai_access_token', token);
            document.cookie = `access_token=${token}; path=/; max-age=86400`;
            document.cookie = `avatarai_token=${token}; path=/; max-age=86400`;
        }

        function getStoredRefreshToken() {
            return localStorage.getItem('avatarai_refresh_token');
        }

        function storeRefreshToken(token) {
            if (token) {
                localStorage.setItem('avatarai_refresh_token', token);
            }
        }

        function getStoredUser() {
            const userStr = localStorage.getItem('avatarai_user');
            if (userStr) {
                try {
                    return JSON.parse(userStr);
                } catch (e) {
                    console.error('解析存储的用户信息失败:', e);
                    localStorage.removeItem('avatarai_user');
                }
            }
            return null;
        }

        function storeUser(user) {
            if (user) {
                localStorage.setItem('avatarai_user', JSON.stringify(user));
            }
        }

                function clearStoredAuth() {
            // 清除localStorage
            localStorage.removeItem('avatarai_access_token');
            localStorage.removeItem('avatarai_refresh_token');
            localStorage.removeItem('avatarai_user');

            // 清除cookies
            deleteCookie('access_token');
            deleteCookie('avatarai_token');

            // 清除定时器
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }

            // 清除全局变量
            accessToken = null;
            currentUser = null;
        }

        // 设置自动刷新令牌
        function setupTokenRefresh() {
            // 清除现有定时器
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }

            // 设置在23小时后自动刷新令牌（令牌有效期24小时）
            tokenRefreshTimer = setTimeout(() => {
                console.log('自动刷新访问令牌');
                refreshAccessToken();
            }, 23 * 60 * 60 * 1000); // 23小时
        }

        // 检查令牌是否需要刷新
        function checkTokenExpiry() {
            const refreshToken = getStoredRefreshToken();
            if (!refreshToken || !accessToken) {
                return;
            }

            try {
                // 解析JWT令牌获取过期时间
                const tokenParts = accessToken.split('.');
                if (tokenParts.length === 3) {
                    const payload = JSON.parse(atob(tokenParts[1]));
                    const currentTime = Math.floor(Date.now() / 1000);
                    const expiryTime = payload.exp;

                    // 如果令牌在5分钟内过期，自动刷新
                    if (expiryTime && (expiryTime - currentTime) < 300) {
                        console.log('令牌即将过期，自动刷新');
                        refreshAccessToken();
                    }
                }
            } catch (e) {
                console.error('解析令牌失败:', e);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function refreshAccessToken() {
            const refreshToken = getStoredRefreshToken();
            if (!refreshToken) {
                showMessage('没有刷新令牌，请重新登录', 'warning');
                clearStoredAuth();
                showWelcome();
                return;
            }

            fetch('/api/oauth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    refresh_token: refreshToken
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('刷新令牌失败');
            })
            .then(data => {
                if (data.access_token) {
                    accessToken = data.access_token;
                    storeToken(accessToken);
                    if (data.refresh_token) {
                        storeRefreshToken(data.refresh_token);
                    }

                                        // 更新用户信息
                    if (data.did && data.handle) {
                        const user = {
                            did: data.did,
                            handle: data.handle
                        };
                        currentUser = user;
                        storeUser(user);
                    }

                    // 重新设置自动刷新定时器
                    setupTokenRefresh();

                    showMessage('访问令牌已刷新', 'success');
                } else {
                    throw new Error('响应中没有新的访问令牌');
                }
            })
            .catch(error => {
                console.error('刷新令牌失败:', error);
                showMessage('刷新令牌失败，请重新登录: ' + error.message, 'error');
                clearStoredAuth();
                showWelcome();
            });
        }

        // ==================== 帖子发布功能 ====================

        function bindPostEvents() {
            // 字符计数
            const postContent = document.getElementById('post-content');
            if (postContent) {
                postContent.addEventListener('input', updateCharCount);
            }

            // 媒体按钮事件
            const addImagesBtn = document.getElementById('add-images-btn');
            if (addImagesBtn) {
                addImagesBtn.addEventListener('click', () => {
                    document.getElementById('images-input').click();
                });
            }

            const addVideoBtn = document.getElementById('add-video-btn');
            if (addVideoBtn) {
                addVideoBtn.addEventListener('click', () => {
                    document.getElementById('video-input').click();
                });
            }

            const addLinkBtn = document.getElementById('add-link-btn');
            if (addLinkBtn) {
                addLinkBtn.addEventListener('click', toggleExternalInput);
            }

            // 文件输入事件
            const imagesInput = document.getElementById('images-input');
            if (imagesInput) {
                imagesInput.addEventListener('change', handleImagesSelect);
            }

            const videoInput = document.getElementById('video-input');
            if (videoInput) {
                videoInput.addEventListener('change', handleVideoSelect);
            }

            // 外部链接事件
            const addExternalBtn = document.getElementById('add-external-btn');
            if (addExternalBtn) {
                addExternalBtn.addEventListener('click', handleExternalAdd);
            }

            const cancelExternalBtn = document.getElementById('cancel-external-btn');
            if (cancelExternalBtn) {
                cancelExternalBtn.addEventListener('click', cancelExternalInput);
            }

            // 帖子表单提交
            const postForm = document.getElementById('post-form');
            if (postForm) {
                postForm.addEventListener('submit', handlePostSubmit);
            }

            // 加载更多按钮
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', loadMoreFeed);
            }
        }

        function updateCharCount() {
            const postContent = document.getElementById('post-content');
            const charCount = document.getElementById('char-count');
            const charCounter = charCount.parentElement;

            const length = postContent.value.length;
            charCount.textContent = length;

            if (length > 2800) {
                charCounter.className = 'char-counter error';
            } else if (length > 2500) {
                charCounter.className = 'char-counter warning';
            } else {
                charCounter.className = 'char-counter';
            }
        }

        function toggleExternalInput() {
            const externalInput = document.getElementById('external-input');
            const addLinkBtn = document.getElementById('add-link-btn');

            if (externalInput.classList.contains('hidden')) {
                externalInput.classList.remove('hidden');
                addLinkBtn.classList.add('active');
                document.getElementById('external-url').focus();
            } else {
                cancelExternalInput();
            }
        }

        function cancelExternalInput() {
            const externalInput = document.getElementById('external-input');
            const addLinkBtn = document.getElementById('add-link-btn');

            externalInput.classList.add('hidden');
            addLinkBtn.classList.remove('active');
            document.getElementById('external-url').value = '';
        }

        async function handleImagesSelect(event) {
            const files = Array.from(event.target.files);
            const maxImages = 4;

            if (postData.images.length + files.length > maxImages) {
                showMessage(`最多只能添加${maxImages}张图片`, 'warning');
                return;
            }

            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    showMessage('只支持图片文件', 'error');
                    continue;
                }

                if (file.size > 10 * 1024 * 1024) {
                    showMessage('图片大小不能超过10MB', 'error');
                    continue;
                }

                try {
                    const uploadResult = await uploadFile(file);
                    const imageData = {
                        cid: uploadResult.cid,
                        file: file,
                        url: uploadResult.url || `/api/blobs?id=${uploadResult.cid}`,
                        alt: file.name
                    };
                    postData.images.push(imageData);
                    updateMediaPreview();
                } catch (error) {
                    showMessage('图片上传失败: ' + error.message, 'error');
                }
            }

            // 清空文件输入
            event.target.value = '';
        }

        async function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('video/')) {
                showMessage('只支持视频文件', 'error');
                return;
            }

            if (file.size > 100 * 1024 * 1024) {
                showMessage('视频大小不能超过100MB', 'error');
                return;
            }

            try {
                const uploadResult = await uploadFile(file);
                postData.video = {
                    cid: uploadResult.cid,
                    file: file,
                    url: uploadResult.url || `/api/blobs?id=${uploadResult.cid}`,
                    alt: file.name
                };
                updateMediaPreview();
            } catch (error) {
                showMessage('视频上传失败: ' + error.message, 'error');
            }

            // 清空文件输入
            event.target.value = '';
        }

        async function handleExternalAdd() {
            const urlInput = document.getElementById('external-url');
            const url = urlInput.value.trim();

            if (!url) {
                showMessage('请输入外部链接URL', 'warning');
                return;
            }

            try {
                new URL(url); // 验证URL格式
            } catch {
                showMessage('请输入有效的URL', 'error');
                return;
            }

            try {
                // 获取链接元数据
                const metadata = await fetchLinkMetadata(url);
                postData.external = {
                    uri: url,
                    title: metadata.title || url,
                    description: metadata.description || '',
                    thumbCid: metadata.thumbCid || ''
                };
                updateMediaPreview();
                cancelExternalInput();
            } catch (error) {
                // 即使获取元数据失败，也添加基本链接
                postData.external = {
                    uri: url,
                    title: url,
                    description: '',
                    thumbCid: ''
                };
                updateMediaPreview();
                cancelExternalInput();
            }
        }

        async function fetchLinkMetadata(url) {
            // 这里应该调用服务端API来获取链接元数据
            // 暂时返回基本信息
            return {
                title: url,
                description: '',
                thumbCid: ''
            };
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/blobs', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                body: formData
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || '上传失败');
            }

            return await response.json();
        }

        function updateMediaPreview() {
            const mediaPreview = document.getElementById('media-preview');
            const imagesPreview = document.getElementById('images-preview');
            const videoPreview = document.getElementById('video-preview');
            const externalPreview = document.getElementById('external-preview');

            // 清空预览
            imagesPreview.innerHTML = '';
            videoPreview.innerHTML = '';
            externalPreview.innerHTML = '';

            let hasMedia = false;

            // 图片预览
            if (postData.images.length > 0) {
                hasMedia = true;
                postData.images.forEach((imageData, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-preview-item';
                    imageItem.innerHTML = `
                        <img src="${imageData.url}" alt="${imageData.alt}">
                        <button class="remove-btn" onclick="removeImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    imagesPreview.appendChild(imageItem);
                });
            }

            // 视频预览
            if (postData.video) {
                hasMedia = true;
                const videoItem = document.createElement('div');
                videoItem.className = 'video-preview-item';
                videoItem.innerHTML = `
                    <video controls>
                        <source src="${postData.video.url}" type="${postData.video.file.type}">
                        您的浏览器不支持视频播放。
                    </video>
                    <button class="remove-btn" onclick="removeVideo()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                videoPreview.appendChild(videoItem);
            }

            // 外部链接预览
            if (postData.external) {
                hasMedia = true;
                const externalItem = document.createElement('div');
                externalItem.className = 'external-preview-item';
                externalItem.innerHTML = `
                    ${postData.external.thumbCid ? `<img src="/api/blobs?id=${postData.external.thumbCid}" class="external-thumb" alt="缩略图">` : '<div class="external-thumb"></div>'}
                    <div class="external-info">
                        <div class="external-title">${escapeHtml(postData.external.title)}</div>
                        <div class="external-desc">${escapeHtml(postData.external.description)}</div>
                        <a href="${postData.external.uri}" class="external-url" target="_blank">${postData.external.uri}</a>
                    </div>
                    <button class="remove-btn" onclick="removeExternal()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                externalPreview.appendChild(externalItem);
            }

            // 显示或隐藏媒体预览区域
            if (hasMedia) {
                mediaPreview.classList.remove('hidden');
            } else {
                mediaPreview.classList.add('hidden');
            }
        }

        function removeImage(index) {
            postData.images.splice(index, 1);
            updateMediaPreview();
        }

        function removeVideo() {
            postData.video = null;
            updateMediaPreview();
        }

        function removeExternal() {
            postData.external = null;
            updateMediaPreview();
        }

        async function handlePostSubmit(event) {
            event.preventDefault();

            const postContent = document.getElementById('post-content');
            const postBtn = document.getElementById('post-btn');
            const text = postContent.value.trim();

            if (!text && postData.images.length === 0 && !postData.video && !postData.external) {
                showMessage('请输入文本内容或添加媒体', 'warning');
                return;
            }

            if (text.length > 3000) {
                showMessage('文本内容不能超过3000个字符', 'error');
                return;
            }

            // 禁用发布按钮
            postBtn.disabled = true;
            postBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发布中...';

            try {
                // 构建帖子数据
                const momentData = {
                    text: text,
                    facets: parseFacets(text),
                    langs: ['zh', 'en'],
                    tags: extractTags(text)
                };

                // 添加图片
                if (postData.images.length > 0) {
                    momentData.images = postData.images.map(img => ({ cid: img.cid }));
                }

                // 添加视频
                if (postData.video) {
                    momentData.video = { cid: postData.video.cid };
                }

                // 添加外部链接
                if (postData.external) {
                    momentData.external = postData.external;
                }

                // 发送创建帖子请求
                const response = await fetch('/api/moments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: JSON.stringify(momentData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || '发布失败');
                }

                const result = await response.json();
                console.log('帖子发布成功:', result);

                // 清空表单
                resetPostForm();
                showMessage('帖子发布成功！', 'success');

                // 刷新Feed流
                setTimeout(() => {
                    loadFeedData(true);
                }, 1000);

            } catch (error) {
                console.error('发布帖子失败:', error);
                showMessage('发布失败: ' + error.message, 'error');
            } finally {
                // 恢复发布按钮
                postBtn.disabled = false;
                postBtn.innerHTML = '<i class="fas fa-share"></i> 发布';
            }
        }

        function resetPostForm() {
            document.getElementById('post-content').value = '';
            postData.images = [];
            postData.video = null;
            postData.external = null;
            updateCharCount();
            updateMediaPreview();
            cancelExternalInput();
        }

        function parseFacets(text) {
            const facets = [];

            // 解析标签 #tag
            const tagRegex = /#(\w+)/g;
            let tagMatch;
            while ((tagMatch = tagRegex.exec(text)) !== null) {
                facets.push({
                    index: {
                        byteStart: tagMatch.index,
                        byteEnd: tagMatch.index + tagMatch[0].length
                    },
                    features: [{
                        $type: 'app.bsky.richtext.facet#tag',
                        tag: tagMatch[1]
                    }]
                });
            }

            // 解析链接 http(s)://
            const linkRegex = /https?:\/\/[^\s]+/g;
            let linkMatch;
            while ((linkMatch = linkRegex.exec(text)) !== null) {
                facets.push({
                    index: {
                        byteStart: linkMatch.index,
                        byteEnd: linkMatch.index + linkMatch[0].length
                    },
                    features: [{
                        $type: 'app.bsky.richtext.facet#link',
                        uri: linkMatch[0]
                    }]
                });
            }

            // 解析提及 @handle (简化版，实际需要验证handle是否存在)
            const mentionRegex = /@(\w+(?:\.\w+)*)/g;
            let mentionMatch;
            while ((mentionMatch = mentionRegex.exec(text)) !== null) {
                facets.push({
                    index: {
                        byteStart: mentionMatch.index,
                        byteEnd: mentionMatch.index + mentionMatch[0].length
                    },
                    features: [{
                        $type: 'app.bsky.richtext.facet#mention',
                        did: 'did:plc:unknown' // 实际应该解析handle得到DID
                    }]
                });
            }

            return facets.length > 0 ? facets : undefined;
        }

        function extractTags(text) {
            const tags = [];
            const tagRegex = /#(\w+)/g;
            let match;

            while ((match = tagRegex.exec(text)) !== null) {
                const tag = match[1];
                if (!tags.includes(tag)) {
                    tags.push(tag);
                }
            }

            return tags.length > 0 ? tags : undefined;
        }

        // ==================== Feed 流功能 ====================

        async function loadFeedData(refresh = false) {
            if (refresh) {
                feedCursor = null;
            }

            try {
                const params = new URLSearchParams();
                params.set('limit', '20');
                if (feedCursor) {
                    params.set('cursor', feedCursor);
                }

                const response = await fetch(`/api/feeds?${params}`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error('获取Feed失败');
                }

                const feedData = await response.json();
                console.log('Feed数据:', feedData);

                if (refresh) {
                    clearFeedList();
                }

                displayFeedCards(feedData.feed || []);
                feedCursor = feedData.cursor;

                // 更新加载更多按钮
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (feedCursor && feedData.feed && feedData.feed.length > 0) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }

            } catch (error) {
                console.error('加载Feed失败:', error);
                showMessage('加载动态失败: ' + error.message, 'error');
            }
        }

        function clearFeedList() {
            const feedList = document.getElementById('feed-list');
            feedList.innerHTML = '';
        }

        function displayFeedCards(cards) {
            const feedList = document.getElementById('feed-list');

            if (cards.length === 0 && feedList.children.length === 0) {
                feedList.innerHTML = `
                    <div class="welcome-animation">
                        <div class="welcome-icon">
                            <i class="fas fa-newspaper"></i>
                        </div>
                        <div class="welcome-text">
                            暂无动态，发布第一条帖子吧！
                        </div>
                    </div>
                `;
                return;
            }

            cards.forEach(feedCard => {
                if (feedCard.type === 'moment') {
                    const cardElement = createMomentCard(feedCard.card);
                    feedList.appendChild(cardElement);
                }
            });
        }

        function createMomentCard(moment) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'feed-card';
            cardDiv.setAttribute('data-moment-id', moment.id);
            cardDiv.setAttribute('data-moment-uri', moment.uri || buildMomentURI(moment.id));

            const authorAvatar = moment.author.avatar || '';
            const authorName = moment.author.displayName || moment.author.handle || 'Unknown';
            const authorHandle = moment.author.handle || '';
            const avatarContent = authorAvatar ?
                `<img src="${authorAvatar}" alt="${authorName}">` :
                authorName.charAt(0).toUpperCase();

            const createdTime = new Date(moment.createdAt * 1000).toLocaleString('zh-CN');

            // 处理回复信息
            let replyInfo = '';
            if (moment.reply && moment.reply.parent) {
                replyInfo = `
                    <div class="feed-card-reply-info">
                        <i class="fas fa-reply"></i> 回复了一条帖子
                    </div>
                `;
            }

            // 处理媒体内容
            let mediaContent = '';
            if (moment.embed) {
                if (moment.embed.images && moment.embed.images.length > 0) {
                    mediaContent += '<div class="feed-card-images">';
                    moment.embed.images.forEach(img => {
                        const imageUrl = img.thumb || `/api/blobs?id=${img.cid}`;
                        mediaContent += `<img src="${imageUrl}" alt="${img.alt || '图片'}" onclick="showImageModal('${imageUrl}')">`;
                    });
                    mediaContent += '</div>';
                }

                if (moment.embed.video) {
                    const videoUrl = moment.embed.video.video || `/api/blobs?id=${moment.embed.video.cid}`;
                    mediaContent += `
                        <div class="feed-card-video">
                            <video controls>
                                <source src="${videoUrl}" type="video/mp4">
                                您的浏览器不支持视频播放。
                            </video>
                        </div>
                    `;
                }

                if (moment.embed.external) {
                    const ext = moment.embed.external;
                    const thumbUrl = ext.thumbURL || (ext.thumbCid ? `/api/blobs?id=${ext.thumbCid}` : '');
                    mediaContent += `
                        <div class="feed-card-external">
                            ${thumbUrl ? `<img src="${thumbUrl}" class="feed-card-external-thumb" alt="缩略图">` : ''}
                            <div class="feed-card-external-content">
                                <div class="feed-card-external-title">${escapeHtml(ext.title || ext.uri)}</div>
                                ${ext.description ? `<div class="feed-card-external-desc">${escapeHtml(ext.description)}</div>` : ''}
                                <a href="${ext.uri}" class="feed-card-external-url" target="_blank">${ext.uri}</a>
                            </div>
                        </div>
                    `;
                }
            }

            // 处理标签
            let tagsContent = '';
            if (moment.tags && moment.tags.length > 0) {
                tagsContent = '<div class="feed-card-tags">';
                moment.tags.forEach(tag => {
                    tagsContent += `<span class="feed-card-tag">#${tag}</span>`;
                });
                tagsContent += '</div>';
            }

            cardDiv.innerHTML = `
                <div class="feed-card-header">
                    <div class="feed-card-avatar">${avatarContent}</div>
                    <div class="feed-card-author">
                        <div class="handle">${escapeHtml(authorName)}</div>
                        <div class="did">@${escapeHtml(authorHandle)}</div>
                    </div>
                    <div class="feed-card-time">${createdTime}</div>
                </div>
                ${replyInfo}
                <div class="feed-card-content">${escapeHtml(moment.text)}</div>
                ${mediaContent}
                ${tagsContent}
                <div class="feed-card-actions">
                    <button class="action-btn reply-btn" onclick="showReplyForm('${moment.id}', '${moment.uri || buildMomentURI(moment.id)}')">
                        <i class="fas fa-reply"></i> 回复
                    </button>
                    <button class="action-btn thread-btn" onclick="showThread('${moment.uri || buildMomentURI(moment.id)}')">
                        <i class="fas fa-comments"></i> 查看对话
                    </button>
                </div>
                <div class="reply-form-container" id="reply-form-${moment.id}" style="display: none;"></div>
            `;

            return cardDiv;
        }

        function loadMoreFeed() {
            loadFeedData(false);
        }

        function showImageModal(imageUrl) {
            // 简单的图片查看模态框
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;

            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
            `;

            modal.appendChild(img);
            document.body.appendChild(modal);

            modal.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // ==================== 回复功能 ====================

        // 全局回复数据
        let replyData = {};

        function buildMomentURI(momentId) {
            if (!currentUser) return '';
            return `at://${currentUser.did}/app.vtri.activity.moment/${momentId}`;
        }

        function showReplyForm(momentId, momentUri) {
            const container = document.getElementById(`reply-form-${momentId}`);
            if (!container) return;

            // 如果已经显示，则隐藏
            if (container.style.display !== 'none') {
                hideReplyForm(momentId);
                return;
            }

            // 初始化回复数据
            replyData[momentId] = {
                images: [],
                video: null,
                external: null
            };

            // 创建回复表单
            container.innerHTML = createReplyFormHTML(momentId, momentUri);
            container.style.display = 'block';

            // 绑定事件
            bindReplyFormEvents(momentId);

            // 聚焦到文本框
            const textarea = container.querySelector('.reply-textarea');
            if (textarea) {
                textarea.focus();
            }
        }

        function hideReplyForm(momentId) {
            const container = document.getElementById(`reply-form-${momentId}`);
            if (container) {
                container.style.display = 'none';
                container.innerHTML = '';
            }
            // 清理回复数据
            delete replyData[momentId];
        }

        function createReplyFormHTML(momentId, momentUri) {
            return `
                <div class="reply-form">
                    <div class="reply-to-info">
                        <i class="fas fa-reply"></i> 回复此帖子
                    </div>

                    <textarea
                        class="reply-textarea"
                        placeholder="输入你的回复..."
                        maxlength="3000"
                        id="reply-text-${momentId}"
                    ></textarea>

                    <!-- 媒体预览区域 -->
                    <div id="reply-media-preview-${momentId}" class="media-preview hidden">
                        <div id="reply-images-preview-${momentId}" class="images-preview"></div>
                        <div id="reply-video-preview-${momentId}" class="video-preview"></div>
                        <div id="reply-external-preview-${momentId}" class="external-preview"></div>
                    </div>

                    <!-- 外部链接输入 -->
                    <div id="reply-external-input-${momentId}" class="form-group hidden">
                        <input
                            id="reply-external-url-${momentId}"
                            type="url"
                            placeholder="输入外部链接URL"
                            style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;"
                        >
                        <div style="margin-top: 8px;">
                            <button type="button" class="btn" onclick="addReplyExternal('${momentId}')">
                                <i class="fas fa-plus"></i> 添加链接
                            </button>
                            <button type="button" class="btn btn-danger" onclick="cancelReplyExternal('${momentId}')">
                                <i class="fas fa-times"></i> 取消
                            </button>
                        </div>
                    </div>

                    <div class="reply-actions">
                        <div class="reply-media-buttons">
                            <button type="button" class="media-btn" onclick="addReplyImages('${momentId}')" title="添加图片">
                                <i class="fas fa-image"></i>
                            </button>
                            <button type="button" class="media-btn" onclick="addReplyVideo('${momentId}')" title="添加视频">
                                <i class="fas fa-video"></i>
                            </button>
                            <button type="button" class="media-btn" onclick="toggleReplyExternal('${momentId}')" title="添加外部链接">
                                <i class="fas fa-link"></i>
                            </button>
                        </div>

                        <div class="reply-submit-actions">
                            <div class="reply-char-counter">
                                <span id="reply-char-count-${momentId}">0</span>/3000
                            </div>
                            <button type="button" class="btn btn-danger" onclick="hideReplyForm('${momentId}')">
                                <i class="fas fa-times"></i> 取消
                            </button>
                            <button type="button" class="btn btn-success" onclick="submitReply('${momentId}', '${momentUri}')">
                                <i class="fas fa-reply"></i> 发布回复
                            </button>
                        </div>
                    </div>

                    <!-- 隐藏的文件输入 -->
                    <input type="file" id="reply-images-input-${momentId}" accept="image/*" multiple style="display: none;">
                    <input type="file" id="reply-video-input-${momentId}" accept="video/*" style="display: none;">
                </div>
            `;
        }

        function bindReplyFormEvents(momentId) {
            // 字符计数
            const textarea = document.getElementById(`reply-text-${momentId}`);
            if (textarea) {
                textarea.addEventListener('input', () => updateReplyCharCount(momentId));
            }

            // 文件输入事件
            const imagesInput = document.getElementById(`reply-images-input-${momentId}`);
            if (imagesInput) {
                imagesInput.addEventListener('change', (e) => handleReplyImagesSelect(momentId, e));
            }

            const videoInput = document.getElementById(`reply-video-input-${momentId}`);
            if (videoInput) {
                videoInput.addEventListener('change', (e) => handleReplyVideoSelect(momentId, e));
            }
        }

        function updateReplyCharCount(momentId) {
            const textarea = document.getElementById(`reply-text-${momentId}`);
            const charCount = document.getElementById(`reply-char-count-${momentId}`);
            const charCounter = charCount.parentElement;

            const length = textarea.value.length;
            charCount.textContent = length;

            if (length > 2800) {
                charCounter.className = 'reply-char-counter error';
            } else if (length > 2500) {
                charCounter.className = 'reply-char-counter warning';
            } else {
                charCounter.className = 'reply-char-counter';
            }
        }

        function addReplyImages(momentId) {
            document.getElementById(`reply-images-input-${momentId}`).click();
        }

        function addReplyVideo(momentId) {
            document.getElementById(`reply-video-input-${momentId}`).click();
        }

        function toggleReplyExternal(momentId) {
            const externalInput = document.getElementById(`reply-external-input-${momentId}`);

            if (externalInput.classList.contains('hidden')) {
                externalInput.classList.remove('hidden');
                document.getElementById(`reply-external-url-${momentId}`).focus();
            } else {
                cancelReplyExternal(momentId);
            }
        }

        function cancelReplyExternal(momentId) {
            const externalInput = document.getElementById(`reply-external-input-${momentId}`);
            externalInput.classList.add('hidden');
            document.getElementById(`reply-external-url-${momentId}`).value = '';
        }

        async function handleReplyImagesSelect(momentId, event) {
            const files = Array.from(event.target.files);
            const maxImages = 4;

            if (!replyData[momentId]) replyData[momentId] = { images: [], video: null, external: null };

            if (replyData[momentId].images.length + files.length > maxImages) {
                showMessage(`最多只能添加${maxImages}张图片`, 'warning');
                return;
            }

            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    showMessage('只支持图片文件', 'error');
                    continue;
                }

                if (file.size > 10 * 1024 * 1024) {
                    showMessage('图片大小不能超过10MB', 'error');
                    continue;
                }

                try {
                    const uploadResult = await uploadFile(file);
                    const imageData = {
                        cid: uploadResult.cid,
                        file: file,
                        url: uploadResult.url || `/api/blobs?id=${uploadResult.cid}`,
                        alt: file.name
                    };
                    replyData[momentId].images.push(imageData);
                    updateReplyMediaPreview(momentId);
                } catch (error) {
                    showMessage('图片上传失败: ' + error.message, 'error');
                }
            }

            // 清空文件输入
            event.target.value = '';
        }

        async function handleReplyVideoSelect(momentId, event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('video/')) {
                showMessage('只支持视频文件', 'error');
                return;
            }

            if (file.size > 100 * 1024 * 1024) {
                showMessage('视频大小不能超过100MB', 'error');
                return;
            }

            try {
                const uploadResult = await uploadFile(file);
                if (!replyData[momentId]) replyData[momentId] = { images: [], video: null, external: null };

                replyData[momentId].video = {
                    cid: uploadResult.cid,
                    file: file,
                    url: uploadResult.url || `/api/blobs?id=${uploadResult.cid}`,
                    alt: file.name
                };
                updateReplyMediaPreview(momentId);
            } catch (error) {
                showMessage('视频上传失败: ' + error.message, 'error');
            }

            // 清空文件输入
            event.target.value = '';
        }

        async function addReplyExternal(momentId) {
            const urlInput = document.getElementById(`reply-external-url-${momentId}`);
            const url = urlInput.value.trim();

            if (!url) {
                showMessage('请输入外部链接URL', 'warning');
                return;
            }

            try {
                new URL(url); // 验证URL格式
            } catch {
                showMessage('请输入有效的URL', 'error');
                return;
            }

            if (!replyData[momentId]) replyData[momentId] = { images: [], video: null, external: null };

            try {
                // 获取链接元数据
                const metadata = await fetchLinkMetadata(url);
                replyData[momentId].external = {
                    uri: url,
                    title: metadata.title || url,
                    description: metadata.description || '',
                    thumbCid: metadata.thumbCid || ''
                };
                updateReplyMediaPreview(momentId);
                cancelReplyExternal(momentId);
            } catch (error) {
                // 即使获取元数据失败，也添加基本链接
                replyData[momentId].external = {
                    uri: url,
                    title: url,
                    description: '',
                    thumbCid: ''
                };
                updateReplyMediaPreview(momentId);
                cancelReplyExternal(momentId);
            }
        }

        function updateReplyMediaPreview(momentId) {
            const mediaPreview = document.getElementById(`reply-media-preview-${momentId}`);
            const imagesPreview = document.getElementById(`reply-images-preview-${momentId}`);
            const videoPreview = document.getElementById(`reply-video-preview-${momentId}`);
            const externalPreview = document.getElementById(`reply-external-preview-${momentId}`);

            if (!mediaPreview || !replyData[momentId]) return;

            // 清空预览
            imagesPreview.innerHTML = '';
            videoPreview.innerHTML = '';
            externalPreview.innerHTML = '';

            let hasMedia = false;
            const data = replyData[momentId];

            // 图片预览
            if (data.images.length > 0) {
                hasMedia = true;
                data.images.forEach((imageData, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-preview-item';
                    imageItem.innerHTML = `
                        <img src="${imageData.url}" alt="${imageData.alt}">
                        <button class="remove-btn" onclick="removeReplyImage('${momentId}', ${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    imagesPreview.appendChild(imageItem);
                });
            }

            // 视频预览
            if (data.video) {
                hasMedia = true;
                const videoItem = document.createElement('div');
                videoItem.className = 'video-preview-item';
                videoItem.innerHTML = `
                    <video controls>
                        <source src="${data.video.url}" type="${data.video.file.type}">
                        您的浏览器不支持视频播放。
                    </video>
                    <button class="remove-btn" onclick="removeReplyVideo('${momentId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                videoPreview.appendChild(videoItem);
            }

            // 外部链接预览
            if (data.external) {
                hasMedia = true;
                const externalItem = document.createElement('div');
                externalItem.className = 'external-preview-item';
                externalItem.innerHTML = `
                    ${data.external.thumbCid ? `<img src="/api/blobs?id=${data.external.thumbCid}" class="external-thumb" alt="缩略图">` : '<div class="external-thumb"></div>'}
                    <div class="external-info">
                        <div class="external-title">${escapeHtml(data.external.title)}</div>
                        <div class="external-desc">${escapeHtml(data.external.description)}</div>
                        <a href="${data.external.uri}" class="external-url" target="_blank">${data.external.uri}</a>
                    </div>
                    <button class="remove-btn" onclick="removeReplyExternal('${momentId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                externalPreview.appendChild(externalItem);
            }

            // 显示或隐藏媒体预览区域
            if (hasMedia) {
                mediaPreview.classList.remove('hidden');
            } else {
                mediaPreview.classList.add('hidden');
            }
        }

        function removeReplyImage(momentId, index) {
            if (replyData[momentId] && replyData[momentId].images) {
                replyData[momentId].images.splice(index, 1);
                updateReplyMediaPreview(momentId);
            }
        }

        function removeReplyVideo(momentId) {
            if (replyData[momentId]) {
                replyData[momentId].video = null;
                updateReplyMediaPreview(momentId);
            }
        }

        function removeReplyExternal(momentId) {
            if (replyData[momentId]) {
                replyData[momentId].external = null;
                updateReplyMediaPreview(momentId);
            }
        }

        async function submitReply(momentId, momentUri) {
            const textarea = document.getElementById(`reply-text-${momentId}`);
            const text = textarea.value.trim();

            if (!text && (!replyData[momentId] || (replyData[momentId].images.length === 0 && !replyData[momentId].video && !replyData[momentId].external))) {
                showMessage('请输入回复内容或添加媒体', 'warning');
                return;
            }

            if (text.length > 3000) {
                showMessage('回复内容不能超过3000个字符', 'error');
                return;
            }

            try {
                // 构建回复数据
                const replyMomentData = {
                    text: text,
                    parentId: momentId,
                    facets: parseFacets(text),
                    langs: ['zh', 'en'],
                    tags: extractTags(text)
                };

                // 添加媒体内容
                const data = replyData[momentId];
                if (data) {
                    if (data.images.length > 0) {
                        replyMomentData.images = data.images.map(img => ({ cid: img.cid }));
                    }

                    if (data.video) {
                        replyMomentData.video = { cid: data.video.cid };
                    }

                    if (data.external) {
                        replyMomentData.external = data.external;
                    }
                }

                // 发送创建回复请求
                const response = await fetch('/api/moments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: JSON.stringify(replyMomentData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || '发布回复失败');
                }

                const result = await response.json();
                console.log('回复发布成功:', result);

                // 隐藏回复表单
                hideReplyForm(momentId);
                showMessage('回复发布成功！', 'success');

                // 刷新Feed流
                setTimeout(() => {
                    loadFeedData(true);
                }, 1000);

            } catch (error) {
                console.error('发布回复失败:', error);
                showMessage('发布回复失败: ' + error.message, 'error');
            }
        }

        // ==================== Thread 查看功能 ====================

        async function showThread(momentUri) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'thread-modal';
            modal.innerHTML = `
                <div class="thread-modal-content">
                    <div class="thread-modal-header">
                        <h3><i class="fas fa-comments"></i> 对话线程</h3>
                        <button class="thread-modal-close" onclick="closeThreadModal()">&times;</button>
                    </div>
                    <div class="thread-content">
                        <div class="thread-loading">
                            <div class="spinner"></div>
                            正在加载对话...
                        </div>
                    </div>
                </div>
            `;

                         document.body.appendChild(modal);

             // 点击模态框外部关闭
             modal.addEventListener('click', (e) => {
                 if (e.target === modal) {
                     closeThreadModal();
                 }
             });

             try {
                // 获取thread数据
                const response = await fetch(`/api/moments/thread?uri=${encodeURIComponent(momentUri)}&depth=10`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error('获取对话失败');
                }

                const threadData = await response.json();
                console.log('Thread数据:', threadData);

                // 渲染thread内容
                renderThreadContent(modal, threadData);

            } catch (error) {
                console.error('加载对话失败:', error);
                const threadContent = modal.querySelector('.thread-content');
                threadContent.innerHTML = `
                    <div class="thread-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        加载对话失败: ${error.message}
                    </div>
                `;
            }
        }

        function renderThreadContent(modal, threadData) {
            const threadContent = modal.querySelector('.thread-content');

            if (!threadData.moment) {
                threadContent.innerHTML = `
                    <div class="thread-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        没有找到对话内容
                    </div>
                `;
                return;
            }

            threadContent.innerHTML = '';

            // 渲染主帖子
            const mainCard = createThreadCard(threadData.moment, 0);
            threadContent.appendChild(mainCard);

            // 递归渲染回复
            if (threadData.replies && threadData.replies.length > 0) {
                renderThreadReplies(threadContent, threadData.replies, 1);
            }
        }

        function renderThreadReplies(container, replies, depth) {
            replies.forEach(reply => {
                if (reply.moment) {
                    const replyCard = createThreadCard(reply.moment, depth);
                    container.appendChild(replyCard);

                    // 递归渲染子回复
                    if (reply.replies && reply.replies.length > 0) {
                        renderThreadReplies(container, reply.replies, depth + 1);
                    }
                }
            });
        }

        function createThreadCard(moment, depth) {
            const cardDiv = document.createElement('div');
            let className = 'thread-card';
            if (depth === 1) {
                className += ' is-reply';
            } else if (depth > 1) {
                className += ' is-nested-reply';
            }
            cardDiv.className = className;

            const authorAvatar = moment.author.avatar || '';
            const authorName = moment.author.displayName || moment.author.handle || 'Unknown';
            const authorHandle = moment.author.handle || '';
            const avatarContent = authorAvatar ?
                `<img src="${authorAvatar}" alt="${authorName}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` :
                `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${authorName.charAt(0).toUpperCase()}</div>`;

            const createdTime = new Date(moment.createdAt * 1000).toLocaleString('zh-CN');

            // 处理媒体内容（简化版）
            let mediaContent = '';
            if (moment.embed) {
                if (moment.embed.images && moment.embed.images.length > 0) {
                    mediaContent += '<div style="margin: 8px 0; display: flex; gap: 8px; flex-wrap: wrap;">';
                    moment.embed.images.forEach(img => {
                        const imageUrl = img.thumb || `/api/blobs?id=${img.cid}`;
                        mediaContent += `<img src="${imageUrl}" alt="${img.alt || '图片'}" style="max-width: 120px; max-height: 120px; border-radius: 6px; cursor: pointer;" onclick="showImageModal('${imageUrl}')">`;
                    });
                    mediaContent += '</div>';
                }

                if (moment.embed.video) {
                    const videoUrl = moment.embed.video.video || `/api/blobs?id=${moment.embed.video.cid}`;
                    mediaContent += `
                        <div style="margin: 8px 0;">
                            <video controls style="max-width: 300px; border-radius: 6px;">
                                <source src="${videoUrl}" type="video/mp4">
                                您的浏览器不支持视频播放。
                            </video>
                        </div>
                    `;
                }
            }

            cardDiv.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    ${avatarContent}
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <strong style="color: #374151;">${escapeHtml(authorName)}</strong>
                            <span style="color: var(--text-light); font-size: 0.9rem;">@${escapeHtml(authorHandle)}</span>
                            <span style="color: var(--text-light); font-size: 0.8rem;">·</span>
                            <span style="color: var(--text-light); font-size: 0.8rem;">${createdTime}</span>
                        </div>
                        <div style="color: #374151; line-height: 1.5; white-space: pre-wrap;">${escapeHtml(moment.text)}</div>
                        ${mediaContent}
                    </div>
                </div>
            `;

            return cardDiv;
        }

        function closeThreadModal() {
            const modal = document.querySelector('.thread-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // ==================== 用户资料编辑功能 ====================

        let profileEditData = {
            avatarFile: null,
            avatarCID: null,
            bannerFile: null,
            bannerCID: null
        };

        function showEditProfileModal() {
            showElement('edit-profile-modal');

            // 填充当前用户信息
            if (currentUser) {
                document.getElementById('edit-display-name').value = currentUser.displayName || '';
                document.getElementById('edit-description').value = currentUser.description || '';

                // 更新字符计数
                updateProfileCharCount('display-name', 50);
                updateProfileCharCount('description', 300);

                // 显示当前头像
                const avatarPreview = document.getElementById('avatar-preview');
                if (currentUser.avatar) {
                    avatarPreview.innerHTML = `<img src="${currentUser.avatar}" alt="头像">`;
                } else {
                    avatarPreview.innerHTML = '<i class="fas fa-user"></i>';
                    avatarPreview.style.background = getAvatarColor(currentUser.handle);
                }

                // 显示当前背景图
                const bannerPreview = document.getElementById('banner-preview');
                if (currentUser.banner) {
                    bannerPreview.innerHTML = `<img src="${currentUser.banner}" alt="背景图">`;
                } else {
                    bannerPreview.innerHTML = '<i class="fas fa-mountain"></i><span>点击或拖拽上传背景图</span>';
                }
            }

            // 绑定事件
            bindProfileEditEvents();
        }

        function hideEditProfileModal() {
            hideElement('edit-profile-modal');
            // 重置编辑数据
            profileEditData = {
                avatarFile: null,
                avatarCID: null,
                bannerFile: null,
                bannerCID: null
            };
        }

        function bindProfileEditEvents() {
            // 字符计数事件
            const displayNameInput = document.getElementById('edit-display-name');
            const descriptionInput = document.getElementById('edit-description');

            displayNameInput.addEventListener('input', () => updateProfileCharCount('display-name', 50));
            descriptionInput.addEventListener('input', () => updateProfileCharCount('description', 300));

            // 文件选择事件
            const avatarInput = document.getElementById('avatar-input');
            const bannerInput = document.getElementById('banner-input');

            avatarInput.addEventListener('change', handleAvatarSelect);
            bannerInput.addEventListener('change', handleBannerSelect);

            // 表单提交事件
            const form = document.getElementById('edit-profile-form');
            form.addEventListener('submit', handleProfileSubmit);

            // 背景图点击上传
            const bannerPreview = document.getElementById('banner-preview');
            bannerPreview.addEventListener('click', selectBanner);
        }

        function updateProfileCharCount(type, maxLength) {
            const input = document.getElementById(`edit-${type.replace('-', '-')}`);
            const counter = document.getElementById(`${type}-count`);
            const length = input.value.length;

            counter.textContent = length;

            if (length > maxLength * 0.9) {
                counter.parentElement.className = 'char-counter warning';
            } else if (length >= maxLength) {
                counter.parentElement.className = 'char-counter error';
            } else {
                counter.parentElement.className = 'char-counter';
            }
        }

        function selectAvatar() {
            document.getElementById('avatar-input').click();
        }

        function selectBanner() {
            document.getElementById('banner-input').click();
        }

        function removeAvatar() {
            profileEditData.avatarFile = null;
            profileEditData.avatarCID = null;

            const avatarPreview = document.getElementById('avatar-preview');
            avatarPreview.innerHTML = '<i class="fas fa-user"></i>';
            avatarPreview.style.background = getAvatarColor(currentUser.handle);
        }

        function removeBanner() {
            profileEditData.bannerFile = null;
            profileEditData.bannerCID = null;

            const bannerPreview = document.getElementById('banner-preview');
            bannerPreview.innerHTML = '<i class="fas fa-mountain"></i><span>点击或拖拽上传背景图</span>';
        }

        async function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showMessage('请选择图片文件', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showMessage('头像文件大小不能超过5MB', 'error');
                return;
            }

            try {
                // 预览图片
                const reader = new FileReader();
                reader.onload = (e) => {
                    const avatarPreview = document.getElementById('avatar-preview');
                    avatarPreview.innerHTML = `<img src="${e.target.result}" alt="头像预览">`;
                };
                reader.readAsDataURL(file);

                // 上传文件
                const uploadResult = await uploadFile(file);
                profileEditData.avatarFile = file;
                profileEditData.avatarCID = uploadResult.cid;

                showMessage('头像上传成功', 'success');
            } catch (error) {
                showMessage('头像上传失败: ' + error.message, 'error');
            }

            // 清空文件输入
            event.target.value = '';
        }

        async function handleBannerSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showMessage('请选择图片文件', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showMessage('背景图文件大小不能超过10MB', 'error');
                return;
            }

            try {
                // 预览图片
                const reader = new FileReader();
                reader.onload = (e) => {
                    const bannerPreview = document.getElementById('banner-preview');
                    bannerPreview.innerHTML = `<img src="${e.target.result}" alt="背景图预览">`;
                };
                reader.readAsDataURL(file);

                // 上传文件
                const uploadResult = await uploadFile(file);
                profileEditData.bannerFile = file;
                profileEditData.bannerCID = uploadResult.cid;

                showMessage('背景图上传成功', 'success');
            } catch (error) {
                showMessage('背景图上传失败: ' + error.message, 'error');
            }

            // 清空文件输入
            event.target.value = '';
        }

        async function handleProfileSubmit(event) {
            event.preventDefault();

            const displayName = document.getElementById('edit-display-name').value.trim();
            const description = document.getElementById('edit-description').value.trim();

            if (displayName.length > 50) {
                showMessage('显示名称不能超过50个字符', 'error');
                return;
            }

            if (description.length > 300) {
                showMessage('个人简介不能超过300个字符', 'error');
                return;
            }

            const saveBtn = document.getElementById('save-profile-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

            try {
                // 构建更新数据
                const updateData = {};

                if (displayName) {
                    updateData.displayName = displayName;
                }

                if (description) {
                    updateData.description = description;
                }

                if (profileEditData.avatarCID) {
                    updateData.avatarCID = profileEditData.avatarCID;
                }

                if (profileEditData.bannerCID) {
                    updateData.bannerCID = profileEditData.bannerCID;
                }

                // 发送更新请求
                const response = await fetch('/api/avatar/profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || '更新失败');
                }

                const result = await response.json();
                console.log('资料更新成功:', result);

                // 更新当前用户信息
                if (displayName) currentUser.displayName = displayName;
                if (description) currentUser.description = description;
                if (profileEditData.avatarCID) {
                    currentUser.avatar = `/api/blobs?id=${profileEditData.avatarCID}`;
                }
                if (profileEditData.bannerCID) {
                    currentUser.banner = `/api/blobs?id=${profileEditData.bannerCID}`;
                }

                // 保存到localStorage
                storeUser(currentUser);

                // 更新显示
                updateUserDisplay(currentUser);

                // 关闭模态框
                hideEditProfileModal();

                showMessage('个人资料更新成功！', 'success');

            } catch (error) {
                console.error('更新个人资料失败:', error);
                showMessage('更新失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存';
            }
        }
    </script>
</body>
</html>
